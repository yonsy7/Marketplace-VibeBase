generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum TemplateStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
}

enum TechStack {
  HTML
  REACT_VITE
  NEXTJS
}

enum FileType {
  HTML
  PROJECT_ZIP
  CSS
  JS
  ASSET
}

enum PlatformType {
  V0
  LOVABLE
  SUBFRAME
  MAGIC_PATTERNS
  UIZARD
  ONLOOK
  REPLIT
  AURA_BUILD
  MAGIC_PATH
  STITCH
}

enum UserRole {
  USER
  CREATOR
  ADMIN
}

// ============================================
// USER MODEL
// ============================================

model User {
  id                    String   @id @unique
  email                 String
  firstName             String
  lastName              String
  username              String?   @unique
  bio                   String?
  role                  UserRole  @default(USER)
  avatarUrl             String?
  profileImage          String    // Keep for backward compatibility
  connectedAccountId    String    @unique
  stripeConnectedLinked Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  Product               Product[] // Keep for backward compatibility during migration
  Templates             Template[]
  Orders                Order[]   @relation("Purchases")
  Reviews               Review[]
  Favorites             Favorite[]
}

// ============================================
// TEMPLATE MODEL (New)
// ============================================

model Template {
  id             String         @id @default(cuid())
  creatorId      String
  title          String
  slug           String         @unique
  byline         String?
  shortDesc      String
  longDesc       String?
  price          Int            @default(0)
  status         TemplateStatus @default(DRAFT)
  techStack      TechStack
  previewFileId  String?
  previewImages  Json?
  liveDemoUrl    String?
  ratingAverage  Float          @default(0)
  ratingCount    Int            @default(0)
  likeCount      Int            @default(0)
  viewCount      Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  creator        User           @relation(fields: [creatorId], references: [id])
  files          TemplateFile[]
  styles         TemplateStyleTag[]
  categories     TemplateCategory[]
  subcategories  TemplateSubcategory[]
  tags           TemplateTag[]
  platforms      TemplatePlatform[]
  orders         Order[]
  reviews        Review[]
  favorites      Favorite[]

  @@index([creatorId])
  @@index([status])
  @@index([techStack])
  @@index([slug])
}

// ============================================
// CLASSIFICATION MODELS
// ============================================

model StyleTag {
  id        String             @id @default(cuid())
  name      String             @unique
  templates TemplateStyleTag[]

  @@index([name])
}

model TemplateStyleTag {
  id         String    @id @default(cuid())
  templateId String
  styleTagId String
  createdAt  DateTime  @default(now())

  template  Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  styleTag  StyleTag  @relation(fields: [styleTagId], references: [id], onDelete: Cascade)

  @@unique([templateId, styleTagId])
  @@index([templateId])
  @@index([styleTagId])
}

model Category {
  id            String              @id @default(cuid())
  name          String              @unique
  description   String?
  icon          String?
  subcategories Subcategory[]
  templates     TemplateCategory[]

  @@index([name])
}

model Subcategory {
  id          String              @id @default(cuid())
  categoryId  String
  name        String
  description String?
  templates   TemplateSubcategory[]

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, name])
  @@index([categoryId])
}

model TemplateCategory {
  id         String   @id @default(cuid())
  templateId String
  categoryId String
  createdAt  DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([templateId, categoryId])
  @@index([templateId])
  @@index([categoryId])
}

model TemplateSubcategory {
  id            String      @id @default(cuid())
  templateId    String
  subcategoryId String
  createdAt     DateTime    @default(now())

  template    Template    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  subcategory Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)

  @@unique([templateId, subcategoryId])
  @@index([templateId])
  @@index([subcategoryId])
}

model Tag {
  id        String        @id @default(cuid())
  name      String        @unique
  templates TemplateTag[]

  @@index([name])
}

model TemplateTag {
  id         String   @id @default(cuid())
  templateId String
  tagId      String
  createdAt  DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([templateId, tagId])
  @@index([templateId])
  @@index([tagId])
}

model TemplatePlatform {
  id         String       @id @default(cuid())
  templateId String
  platform   PlatformType
  createdAt  DateTime     @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, platform])
  @@index([templateId])
  @@index([platform])
}

// ============================================
// TRANSACTIONAL MODELS
// ============================================

model TemplateFile {
  id         String   @id @default(cuid())
  templateId String
  fileUrl    String
  fileType   FileType
  fileName   String
  fileSize   Int?
  isPreview  Boolean  @default(false)
  createdAt  DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model Order {
  id                String   @id @default(cuid())
  buyerId            String
  templateId         String
  paymentIntentId    String   @unique
  stripeSessionId   String?
  amount            Int
  platformFee       Int
  downloadAvailable Boolean  @default(false)
  downloadCount     Int      @default(0)
  createdAt         DateTime @default(now())

  buyer    User     @relation("Purchases", fields: [buyerId], references: [id])
  template Template @relation(fields: [templateId], references: [id])

  @@index([buyerId])
  @@index([templateId])
  @@index([paymentIntentId])
}

model Review {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
}

model Favorite {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  createdAt  DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([templateId, userId])
  @@index([userId])
  @@index([templateId])
}

// ============================================
// LEGACY MODEL (Keep for backward compatibility)
// ============================================

model Product {
  id               String        @id @default(uuid())
  name             String
  price            Int
  smallDescription String
  description      Json
  images           String[]
  productFile      String
  category         CategoryTypes
  createdAt        DateTime      @default(now())
  User             User?         @relation(fields: [userId], references: [id])
  userId           String?

  @@index([userId])
}

enum CategoryTypes {
  template
  uikit
  icon
}
