generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum TemplateStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
}

enum TechStack {
  HTML
  REACT_VITE
  NEXTJS
}

enum FileType {
  HTML
  PROJECT_ZIP
  CSS
  JS
  ASSET
}

enum PlatformType {
  V0
  LOVABLE
  SUBFRAME
  MAGIC_PATTERNS
  UIZARD
  ONLOOK
  REPLIT
  AURA_BUILD
  MAGIC_PATH
  STITCH
}

enum UserRole {
  USER
  CREATOR
  ADMIN
}

// Keep old CategoryTypes for backward compatibility during migration
enum CategoryTypes {
  template
  uikit
  icon
}

// User Model - Updated
model User {
  id                    String    @id @unique
  email                 String
  firstName             String
  lastName              String
  profileImage          String
  username              String?   @unique
  bio                   String?
  role                  UserRole  @default(USER)
  connectedAccountId    String    @unique
  stripeConnectedLinked Boolean   @default(false)
  createdAt             DateTime  @default(now())

  // Old relation for backward compatibility
  Product   Product[]
  
  // New relations
  templates Template[]
  orders    Order[]     @relation("Purchases")
  reviews   Review[]
  favorites Favorite[]
}

// Old Product Model - Keep for migration
model Product {
  id               String        @id @default(uuid())
  name             String
  price            Int
  smallDescription String
  description      Json
  images           String[]
  productFile      String
  category         CategoryTypes

  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

// New Template Model
model Template {
  id             String         @id @default(cuid())
  creatorId      String
  title          String
  slug           String         @unique
  byline         String?
  shortDesc      String
  longDesc       String?
  price          Int            @default(0)
  status         TemplateStatus @default(DRAFT)
  techStack      TechStack
  previewFileId  String?
  previewImages  Json?
  liveDemoUrl    String?
  ratingAverage  Float          @default(0)
  ratingCount    Int            @default(0)
  likeCount      Int            @default(0)
  viewCount      Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  creator       User                  @relation(fields: [creatorId], references: [id])
  files         TemplateFile[]
  styles        TemplateStyleTag[]
  categories    TemplateCategory[]
  subcategories TemplateSubcategory[]
  tags          TemplateTag[]
  platforms     TemplatePlatform[]
  orders        Order[]
  reviews       Review[]
  favorites     Favorite[]

  @@index([creatorId])
  @@index([status])
  @@index([techStack])
}

// Template Files
model TemplateFile {
  id         String   @id @default(cuid())
  templateId String
  fileUrl    String
  fileType   FileType
  fileName   String
  fileSize   Int?
  isPreview  Boolean  @default(false)

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

// Style Tags
model StyleTag {
  id        String             @id @default(cuid())
  name      String             @unique
  slug      String             @unique
  templates TemplateStyleTag[]
}

model TemplateStyleTag {
  id         String @id @default(cuid())
  templateId String
  styleId    String

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  style    StyleTag @relation(fields: [styleId], references: [id], onDelete: Cascade)

  @@unique([templateId, styleId])
}

// Categories
model Category {
  id            String             @id @default(cuid())
  name          String             @unique
  slug          String             @unique
  description   String?
  icon          String?
  subcategories Subcategory[]
  templates     TemplateCategory[]
}

model Subcategory {
  id         String                @id @default(cuid())
  name       String
  slug       String                @unique
  categoryId String
  category   Category              @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  templates  TemplateSubcategory[]

  @@index([categoryId])
}

model TemplateCategory {
  id         String @id @default(cuid())
  templateId String
  categoryId String

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([templateId, categoryId])
}

model TemplateSubcategory {
  id            String @id @default(cuid())
  templateId    String
  subcategoryId String

  template    Template    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  subcategory Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)

  @@unique([templateId, subcategoryId])
}

// Tags
model Tag {
  id        String        @id @default(cuid())
  name      String        @unique
  slug      String        @unique
  templates TemplateTag[]
}

model TemplateTag {
  id         String @id @default(cuid())
  templateId String
  tagId      String

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([templateId, tagId])
}

// Platform Compatibility
model TemplatePlatform {
  id         String       @id @default(cuid())
  templateId String
  platform   PlatformType

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, platform])
}

// Orders
model Order {
  id                String   @id @default(cuid())
  buyerId           String
  templateId        String
  paymentIntentId   String   @unique
  stripeSessionId   String?
  amount            Int
  platformFee       Int
  downloadAvailable Boolean  @default(false)
  downloadCount     Int      @default(0)
  createdAt         DateTime @default(now())

  buyer    User     @relation("Purchases", fields: [buyerId], references: [id])
  template Template @relation(fields: [templateId], references: [id])

  @@index([buyerId])
  @@index([templateId])
}

// Reviews
model Review {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([templateId, userId])
  @@index([templateId])
}

// Favorites
model Favorite {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  createdAt  DateTime @default(now())

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([templateId, userId])
  @@index([userId])
}
